name: Build APK (fixed: package libnode + pinned Gradle)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      # 没有 gradlew 时，Pin 一个 Gradle 版本，避免 runner 自带 Gradle 版本波动导致打包结果不一致
      - name: Set up Gradle (pinned)
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: "8.7"

      - name: Locate project root (supports raw repo or zip)
        run: |
          set -e

          # 兼容两种仓库结构：
          # 1) 仓库里直接是 Android 工程（settings.gradle(.kts) 在根目录）
          # 2) 仓库里只有一个 DanmuApiApp.zip（需要先解压）

          if [ -f "DanmuApiApp.zip" ]; then
            echo "Found DanmuApiApp.zip, unzip..."
            rm -rf project
            mkdir -p project
            unzip -q DanmuApiApp.zip -d project
            SEARCH_ROOT="project"
          else
            SEARCH_ROOT="."
          fi

          echo "=== tree (top) ==="
          find "$SEARCH_ROOT" -maxdepth 3 -print | sed -n '1,200p'

          ROOT="$(find "$SEARCH_ROOT" -maxdepth 10 -type f \( -name 'settings.gradle' -o -name 'settings.gradle.kts' \) -print -quit | xargs -r dirname)"
          if [ -z "$ROOT" ]; then
            echo "❌ 没找到 settings.gradle / settings.gradle.kts。"
            exit 1
          fi

          echo "PROJECT_ROOT=$ROOT" >> $GITHUB_ENV
          echo "Project root: $ROOT"

      - name: Fetch & install libnode (nodejs-mobile)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          mkdir -p /tmp/nodejs-mobile

          echo "=== Release assets ==="
          gh release view v18.20.4 -R nodejs-mobile/nodejs-mobile --json assets --jq '.assets[].name'

          # 用通配符下载：不再假设附件一定叫 android.zip
          gh release download v18.20.4 -R nodejs-mobile/nodejs-mobile -p "*android*.zip" -D /tmp/nodejs-mobile

          echo "=== Downloaded files ==="
          ls -lh /tmp/nodejs-mobile

          ANDROID_ZIP="$(ls /tmp/nodejs-mobile/*android*.zip | head -n 1)"
          if [ -z "$ANDROID_ZIP" ]; then
            echo "❌ 没找到 *android*.zip，说明这个 release 的附件命名更特殊。请看上面打印的 assets 列表。"
            exit 1
          fi

          echo "Using zip: $ANDROID_ZIP"
          unzip -t "$ANDROID_ZIP" >/dev/null

          rm -rf /tmp/nodejs-mobile/out
          mkdir -p /tmp/nodejs-mobile/out
          unzip -q "$ANDROID_ZIP" -d /tmp/nodejs-mobile/out

          cd "$PROJECT_ROOT"
          mkdir -p app/libnode/include app/libnode/bin
          cp -R /tmp/nodejs-mobile/out/include/* app/libnode/include/
          cp -R /tmp/nodejs-mobile/out/bin/* app/libnode/bin/

          if ! find app/libnode/bin -name "libnode.so" | grep -q .; then
            echo "❌ libnode.so 没拷进去（期望 app/libnode/bin/arm64-v8a/libnode.so 等）"
            exit 1
          fi

      - name: Build Debug APK
        env:
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx2g -Dkotlin.daemon.jvm.options=-Xmx1g"
        run: |
          set -e
          cd "$PROJECT_ROOT"

          # 若你后续加入 gradle wrapper，这里会优先使用 ./gradlew
          if [ -f "./gradlew" ]; then
            chmod +x ./gradlew
            ./gradlew --no-daemon :app:assembleDebug
          else
            gradle --no-daemon :app:assembleDebug
          fi

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: ${{ env.PROJECT_ROOT }}/app/build/outputs/apk/debug/*.apk
