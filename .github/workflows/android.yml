name: Build APK (ARM only, split by ABI) + Publish Release

on:
  workflow_dispatch:
    inputs:
      version_name:
        description: "App 版本号（用于 versionName 和 Release tag，比如 0.2.0）"
        required: true
        type: string
      version_code:
        description: "versionCode（可选；留空则使用 GITHUB_RUN_NUMBER）"
        required: false
        type: string
      release_notes:
        description: "发行版说明（可选）"
        required: false
        type: string

permissions:
  contents: write

env:
  # ⚠️ 这里填你仓库里项目 zip 的文件名
  PROJECT_ZIP: DanmuApiApp_optimized_fix2_updated.zip

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve version inputs
        run: |
          set -euo pipefail
          VN="${{ inputs.version_name }}"
          VN="${VN#v}"
          VN="${VN#V}"
          echo "APP_VERSION_NAME=$VN" >> $GITHUB_ENV
          if [ -n "${{ inputs.version_code }}" ]; then
            echo "APP_VERSION_CODE=${{ inputs.version_code }}" >> $GITHUB_ENV
          else
            echo "APP_VERSION_CODE=${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV
          fi
          NOTES="${{ inputs.release_notes }}"
          if [ -z "$NOTES" ]; then
            NOTES="Automated build for v$VN"
          fi
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "$NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Unzip project and locate root
        run: |
          set -euo pipefail
          rm -rf project
          mkdir -p project
          unzip -q -DD "$PROJECT_ZIP" -d project

          ROOT="$(find project -maxdepth 10 -type f \( -name 'settings.gradle' -o -name 'settings.gradle.kts' \) -print -quit | xargs -r dirname)"
          if [ -z "$ROOT" ]; then
            echo "❌ 没找到 settings.gradle / settings.gradle.kts。"
            exit 1
          fi
          echo "PROJECT_ROOT=$ROOT" >> $GITHUB_ENV
          echo "Project root: $ROOT"

      # ✅ 固定签名（可选）
      - name: Prepare signing keystore (optional)
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -n "${ANDROID_KEYSTORE_BASE64:-}" ]; then
            echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > "$PROJECT_ROOT/ci_keystore.jks"
            echo "ANDROID_KEYSTORE_PATH=$PROJECT_ROOT/ci_keystore.jks" >> $GITHUB_ENV
            echo "ANDROID_KEYSTORE_PASSWORD=$ANDROID_KEYSTORE_PASSWORD" >> $GITHUB_ENV
            echo "ANDROID_KEY_ALIAS=$ANDROID_KEY_ALIAS" >> $GITHUB_ENV
            echo "ANDROID_KEY_PASSWORD=$ANDROID_KEY_PASSWORD" >> $GITHUB_ENV
            echo "✅ Keystore prepared"
          else
            echo "ℹ️ 未配置 keystore secrets，将使用 debug key 签名（release 也会 fallback 到 debug，保证可安装）"
          fi

      - name: Fetch & install libnode (ARM only)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p /tmp/nodejs-mobile
          gh release download v18.20.4 -R nodejs-mobile/nodejs-mobile -p "*android*.zip" -D /tmp/nodejs-mobile
          ANDROID_ZIP="$(ls /tmp/nodejs-mobile/*android*.zip | head -n 1)"
          unzip -q "$ANDROID_ZIP" -d /tmp/nodejs-mobile/out

          cd "$PROJECT_ROOT"
          rm -rf app/libnode/include app/libnode/bin
          mkdir -p app/libnode/include app/libnode/bin
          cp -R /tmp/nodejs-mobile/out/include/* app/libnode/include/

          for ABI in arm64-v8a armeabi-v7a; do
            mkdir -p "app/libnode/bin/$ABI"
            cp -R "/tmp/nodejs-mobile/out/bin/$ABI/"* "app/libnode/bin/$ABI/"
          done

      - name: Normalize timestamps (fix ninja dirty loop)
        run: |
          cd "$PROJECT_ROOT"
          find . -type f -exec touch {} +

      - name: Patch native-lib.cpp (argv const -> non-const)
        run: |
          FILE="$PROJECT_ROOT/app/src/main/cpp/native-lib.cpp"
          if [ -f "$FILE" ]; then
            sed -i 's/return node::Start(argc, argv.data());/return node::Start(argc, const_cast<char**>(argv.data()));/g' "$FILE"
          fi

      - name: Build Release APK (split by ABI)
        env:
          GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx2g -Dkotlin.daemon.jvm.options=-Xmx1g"
          APP_VERSION_NAME: ${{ env.APP_VERSION_NAME }}
          APP_VERSION_CODE: ${{ env.APP_VERSION_CODE }}
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"
          chmod +x ./gradlew
          ./gradlew --no-daemon :app:clean :app:assembleRelease -PAPP_VERSION_NAME="$APP_VERSION_NAME" -PAPP_VERSION_CODE="$APP_VERSION_CODE"
          ls -lh app/build/outputs/apk/release || true

      - name: Collect APKs
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"
          APK_DIR="app/build/outputs/apk/release"
          mkdir -p dist

          for ABI in arm64-v8a armeabi-v7a; do
            SRC="$(ls -1 "$APK_DIR"/*"$ABI"*.apk 2>/dev/null | head -n 1 || true)"
            if [ -z "$SRC" ]; then
              echo "❌ 没找到 $ABI 的 APK（检查 splits 输出路径/命名）"
              ls -R "$APK_DIR" || true
              exit 1
            fi
            cp "$SRC" "dist/DanmuApiApp-${APP_VERSION_NAME}-${ABI}.apk"
          done

          ls -lh dist

      - name: Create / update GitHub Release and upload APKs
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="v${APP_VERSION_NAME}"
          REPO="${GITHUB_REPOSITORY}"

          if gh release view "$TAG" -R "$REPO" >/dev/null 2>&1; then
            echo "ℹ️ Release $TAG 已存在，将覆盖上传 APK"
            gh release edit "$TAG" -R "$REPO" --title "$TAG" --notes "$RELEASE_NOTES"
          else
            gh release create "$TAG" -R "$REPO" --title "$TAG" --notes "$RELEASE_NOTES"
          fi

          gh release upload "$TAG" -R "$REPO" "$PROJECT_ROOT/dist/"*.apk --clobber
          echo "✅ Uploaded to https://github.com/${REPO}/releases/tag/${TAG}"
